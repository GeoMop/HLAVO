# syntax=docker/dockerfile:1.6
FROM python:3.11-slim-bookworm AS parflow-build

RUN set -eux; \
    apt-get update; \
    apt-get install -y --no-install-recommends \
      ca-certificates \
      build-essential \
      gfortran \
      cmake \
      tcl \
      tcl-dev \
      openmpi-bin \
      libopenmpi-dev \
      wget \
    ; \
    rm -rf /var/lib/apt/lists/*

ENV PARFLOW_PREFIX=/opt/parflow_install
COPY parflow_install.sh /usr/local/bin/parflow_install.sh
RUN set -eux; \
    bash /usr/local/bin/parflow_install.sh

COPY parflow-ldd.sh /usr/local/bin/parflow-ldd.sh
RUN set -eux; \
    bash /usr/local/bin/parflow-ldd.sh /opt/parflow_install

FROM python:3.11-slim-bookworm

# ---- Base OS deps ----
ENV DEBIAN_FRONTEND=noninteractive \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PIP_NO_CACHE_DIR=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

RUN set -eux; \
    apt-get update; \
    apt-get install -y --no-install-recommends \
      ca-certificates \
      bzip2 \
      git \
      gnupg \
      libopenmpi3 \
      openmpi-bin \
      wget \
    ; \
    rm -rf /var/lib/apt/lists/*

COPY --from=parflow-build /opt/parflow_install /opt/parflow
ENV PARFLOW_DIR=/opt/parflow
ENV PATH=/opt/parflow/bin:$PATH
ENV LD_LIBRARY_PATH=/opt/parflow/lib/ldd:$LD_LIBRARY_PATH

# ---- Create a non-root user for safer downstream usage ----
ARG UID=1000
ARG GID=1000
RUN set -eux; \
    groupadd -g "${GID}" "hlavo"; \
    useradd -m -u "${UID}" -g "${GID}" -s /bin/bash "hlavo"; \
    mkdir -p "/home/hlavo/workspace"; \
    chown -R "hlavo:hlavo" "/home/hlavo/workspace"

# ---- Conda environment ----
ENV ENV_REPO_ROOT=/home/hlavo/workspace
WORKDIR $ENV_REPO_ROOT
COPY hlavo_common.sh $ENV_REPO_ROOT/dev/hlavo_common.sh
COPY hlavo-build $ENV_REPO_ROOT/dev/hlavo-build
COPY conda-requirements.yml $ENV_REPO_ROOT/dev/conda-requirements.yml
#COPY test_env.py $ENV_REPO_ROOT/dev/test_env.py
ENV CONDA_BASE=/home/hlavo/miniconda3
ENV HLAVO_USER=hlavo
RUN set -eux; \
    chown -R hlavo:hlavo $ENV_REPO_ROOT
USER hlavo
RUN set -eux; \
    bash $ENV_REPO_ROOT/dev/hlavo-build -c base

USER root
COPY --chmod=755 hlavo-entrypoint /usr/local/bin/hlavo-entrypoint
ENTRYPOINT ["/usr/local/bin/hlavo-entrypoint"]

CMD ["bash"]
