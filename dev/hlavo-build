#!/usr/bin/env bash
set -xeuo pipefail

SCRIPT_ROOT="$( cd -- "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )"

force_flag=""
while [[ "${1:-}" == -* ]]; do
  case "$1" in
    -c)
      HLAVO_MODE="conda"
      shift
      ;;
    -f)
      force_flag="-f"
      shift
      ;;
    *)
      break
      ;;
  esac
done

# shellcheck disable=SC1090
source "$SCRIPT_ROOT/hlavo_common.sh"

WORKSPACE="/home/hlavo/workspace"

usage() {
  cat <<'EOF'
Usage:
  ./hlavo-build image
  ./hlavo-build build [-f]
  ./hlavo-build base [-f]
  ./hlavo-build make-sif
  ./hlavo-build push

Env vars:
  IMAGE_TAG=latest
  IMAGE_REF=hlavo:latest
  SIF_NAME=hlavo.sif
EOF
}

run_smoke_test() {
  local host_workdir
  host_workdir="${REPO_ROOT}/dev/_parflow_smoke"
  mkdir -p "$host_workdir"
  run_cmd python "$ENV_REPO_ROOT/dev/test_env.py"
}

push_image() {
  set_image_vars
  local push_ref
  push_ref="flow123d/hlavo:${IMAGE_REF#*:}"
  docker tag "$IMAGE_REF" "$push_ref"
  docker push "$push_ref"
}

make_sif() {
  if ! command -v singularity >/dev/null 2>&1; then
    die "singularity not found on PATH."
  fi

  set_image_vars
  local sif_name
  sif_name="${SIF_NAME:-hlavo.sif}"
  singularity pull --name "$sif_name" "docker://$IMAGE_REF"
}

cmd="${1:-}"
shift || true
case "$cmd" in
  base)
    base_build $force_flag
    ;;
  build)
    env_build $force_flag
    ;;
  push)
    push_image
    ;;
  test)
    run_smoke_test
    ;;
  make-sif)
    make_sif
    ;;
  *)
    usage
    exit 1
    ;;
esac
