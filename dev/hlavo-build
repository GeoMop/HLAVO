#!/usr/bin/env bash
set -xeuo pipefail

SCRIPT_ROOT="$( cd -- "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )"

if [[ "${1:-}" == "-c" ]]; then
  HLAVO_MODE="conda"
  shift
fi

# shellcheck disable=SC1090
source "$SCRIPT_ROOT/hlavo_common.sh"

WORKSPACE="/home/hlavo/workspace"

usage() {
  cat <<'EOF'
Usage:
  ./hlavo-build image
  ./hlavo-build make-sif
  ./hlavo-build base

Env vars:
  IMAGE_TAG=latest
  IMAGE_REF=hlavo:latest
  SIF_NAME=hlavo.sif
EOF
}

run_smoke_test() {
  set_image_vars
  local host_workdir
  host_workdir="${REPO_ROOT}/_parflow_smoke"
  mkdir -p "$host_workdir"
  docker run --rm \
    -e HLAVO_WORKSPACE="${WORKSPACE}" \
    -v "$REPO_ROOT:${WORKSPACE}" \
    -v "$host_workdir:${WORKSPACE}/_parflow_smoke" \
    -w "${WORKSPACE}" \
    "$IMAGE_REF" \
    sh -lc "${WORKSPACE}/cndenv.sh run -- python ${WORKSPACE}/conda_env_test.py"
}

push_image() {
  docker push "$IMAGE_REF"
}

make_sif() {
  if ! command -v singularity >/dev/null 2>&1; then
    die "singularity not found on PATH."
  fi

  set_image_vars
  local sif_name
  sif_name="${SIF_NAME:-hlavo.sif}"
  singularity pull --name "$sif_name" "docker://$IMAGE_REF"
}


cmd="${1:-}"
shift || true
case "$cmd" in
  base)
    base_build
    ;;
  update)
    env_build
    ;;
  rebuild)
    env_build -f
    ;;
  test)
    run_smoke_test
    ;;
  make-sif)
    make_sif
    ;;
  *)
    usage
    exit 1
    ;;
esac
