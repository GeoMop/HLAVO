#!/usr/bin/env bash
set -xeuo pipefail

SCRIPT_ROOT="$( cd -- "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )"

while [[ "${1:-}" == -* ]]; do
  case "$1" in
    -c)
      HLAVO_MODE="conda"
      shift
      ;;
    -t)
      tty_arg="-it"
      shift
      ;;
    *)
      break
      ;;
  esac
done

source "$SCRIPT_ROOT/hlavo_common.sh"

usage() {
  cat <<'EOF'
Usage:

  ./hlavo [-c] run <command> [args...]  

EOF
}

[[ $# -ge 1 ]] || { usage; exit 1; }
subcmd="$1"
shift || true

case "$subcmd" in
  shell)
    run_cmd "${SHELL:-bash}" -i
    ;;
  codex)

    set_image_vars
    HOST_UID="$(id -u)" HOST_GID="$(id -g)" \
    BASE_IMAGE="$IMAGE_REF" \
    docker compose -f "$SCRIPT_ROOT/docker-compose.yml" run --rm --build \
      -e RUST_LOG=debug \
      -e RUST_BACKTRACE=full \
      codex_env codex --dangerously-bypass-approvals-and-sandbox
    ;;
  run)
    run_cmd "$@"
    ;;
  *)
    usage
    die "Unknown subcommand: $subcmd"
    ;;
esac
